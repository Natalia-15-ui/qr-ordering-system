<script>
  function updateQuantity(button, change) {
    const span = button.parentElement.querySelector('span');
    let qty = parseInt(span.textContent);
    qty = Math.max(0, qty + change);
    span.textContent = qty;
  }

  // sendOrder is now outside and global
  function sendOrder(tableNumber, total, orderDetails) {
    fetch("https://script.google.com/macros/s/AKfycbwRm0RG4f1IXydgGiltKzzund-QLz8WO3hYuEbIgD_zc6rsnNLnAOIDEmt5Grp_DlSA/exec", {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        table: tableNumber,
        order: orderDetails.join(", "),
        total: total,
        timestamp: new Date().toISOString()
      })
    }).then(() => {
      // Replace entire page content with confirmation message
      document.body.innerHTML = `
        <div style="display:flex; justify-content:center; align-items:center; height:100vh; background: linear-gradient(to top, #000000, #660022); color:#f1ece4; font-family: 'Boston Angel', serif; font-size:2em; text-align:center; padding:20px;">
          We are preparing your order and it will be served at your table shortly.
        </div>
      `;
    }).catch(() => {
      alert("Failed to place order. Please try again.");
      document.getElementById('order-btn').disabled = false; // Re-enable if error happens
    });
  }

  function showPaymentPage() {
    const tableNumber = document.getElementById('table-number').value.trim();
    if (!tableNumber) {
      alert("Please enter your table number.");
      return;
    }
    const items = document.querySelectorAll('.item');
    let total = 0;
    let orderDetails = [];

    items.forEach(item => {
      const name = item.querySelector('span').textContent;
      const priceText = item.querySelector('.price').textContent.replace(/,/g, '');
      const price = parseFloat(priceText);
      const qty = parseInt(item.querySelector('.qty-buttons span').textContent);
      if (qty > 0) {
        total += price * qty;
        orderDetails.push(`${name} x${qty}`);
      }
    });

    if (total === 0) {
      alert("Please select at least one item.");
      return;
    }

    // Hide order form and show qr page
    document.getElementById('order-form').style.display = 'none';
    const qrPage = document.getElementById('qr-page');
    qrPage.style.display = 'block';

    // Create and show QR code image
    const totalFixed = total.toFixed(2);
    const promptpayNumber = "0829959438"; // your PromptPay number
    const qrCodeUrl = `https://promptpay.io/${promptpayNumber}/${totalFixed}`;
    const qrCodeDiv = document.getElementById('qr-code');
    qrCodeDiv.innerHTML = `<img src="${qrCodeUrl}" alt="PromptPay QR Code" />`;

    // Show payment info
    document.getElementById('payment-info').textContent = `Table: ${tableNumber} | Total: à¸¿${totalFixed}`;

    // Disable order button initially
    const orderBtn = document.getElementById('order-btn');
    orderBtn.disabled = true;

    // Setup click handler for "I've Paid"
    const paidBtn = document.getElementById('paid-btn');
    paidBtn.onclick = () => {
      paidBtn.disabled = true;
      paidBtn.textContent = "Payment Verified";
      orderBtn.disabled = false;
      document.getElementById('payment-message').textContent = "Payment verified! You can now place your order.";
    };

    // Setup click handler for Order button
    orderBtn.onclick = () => {
      orderBtn.disabled = true;  // Disable immediately to prevent duplicate clicks
      sendOrder(tableNumber, total, orderDetails);
    };
  }
</script>
